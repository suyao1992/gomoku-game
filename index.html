<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>五子棋遇！ | GomokuZero</title>

    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#a855f7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="五子棋遇">
    <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- CSS模块化加载 -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/multiplayer-ui.css">
    <link rel="stylesheet" href="css/settings-modal.css">
    <link rel="stylesheet" href="css/community.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- Firebase配置 - 必须在SDK之后加载 -->
    <script src="js/firebaseConfig.js"></script>

    <!-- 模块化JS文件 -->
</head>

<body>
    <!-- 加载屏幕 -->
    <!-- Tech Style Loading Screen -->
    <div id="loading-screen" class="loading-screen quantum-theme">
        <!-- 量子粒子背景 -->
        <div class="quantum-particles">
            <div class="quantum-particle p1"></div>
            <div class="quantum-particle p2"></div>
            <div class="quantum-particle p3"></div>
            <div class="quantum-particle p4"></div>
            <div class="quantum-particle p5"></div>
            <div class="quantum-particle p6"></div>
        </div>

        <div class="loading-content">
            <!-- 标题 - 纯中文无emoji -->
            <div class="quantum-logo">
                <span class="logo-text">五子棋遇</span>
                <div class="logo-glow"></div>
            </div>

            <!-- 量子纠缠棋子动画 -->
            <div class="quantum-entanglement">
                <!-- 量子波纹 - 现在在纠缠容器内，与核心同中心 -->
                <div class="quantum-ripples">
                    <div class="quantum-ripple r1"></div>
                    <div class="quantum-ripple r2"></div>
                    <div class="quantum-ripple r3"></div>
                </div>
                <div class="entanglement-orbit">
                    <div class="quantum-stone stone-yin"></div>
                    <div class="entanglement-beam"></div>
                    <div class="quantum-stone stone-yang"></div>
                </div>
                <div class="entanglement-core"></div>
            </div>

            <!-- 状态文字 -->
            <div class="quantum-status">
                <div class="status-main" id="loading-status">量子初始化中</div>
                <div class="status-sub" id="loading-substatus">正在加载资源...</div>
            </div>

            <!-- 量子进度条 -->
            <div class="quantum-progress-container">
                <div class="quantum-progress-track">
                    <div class="quantum-progress-bar" id="loading-progress"></div>
                    <div class="quantum-progress-glow"></div>
                </div>
                <div class="quantum-progress-text">
                    <span class="loading-percentage">0%</span>
                </div>
            </div>

            <!-- 底部提示 -->
            <div class="quantum-tip" id="loading-tip">「 建立量子连接中 」</div>
        </div>
    </div>

    <!-- 玩家姓名输入弹窗 -->
    <div id="name-input-modal" class="modal hidden">
        <div class="modal-content name-input-content">
            <div class="name-input-header">
                <div class="welcome-icon">🎯</div>
                <h2>欢迎来到五子棋遇！</h2>
                <p class="welcome-subtitle">与「弈·零」一起开启智慧之旅</p>
            </div>
            <div class="name-input-body">
                <label for="player-name-input">请输入您的名字</label>
                <input type="text" id="player-name-input" class="name-input" placeholder="玩家" maxlength="8"
                    autocomplete="off">
                <div class="random-name-buttons">
                    <button type="button" id="random-name-cn" class="btn random-btn">🎲 随机中文</button>
                    <button type="button" id="random-name-en" class="btn random-btn">🎲 随机英文</button>
                </div>
                <p class="name-hint">名字将显示在游戏中（2-8个字符）</p>

                <div class="avatar-section">
                    <label>选择头像</label>
                    <div class="avatar-preview-row">
                        <span id="avatar-preview" class="avatar-preview">🦊</span>
                        <span class="avatar-preview-label">点击下方选择</span>
                    </div>
                    <div id="avatar-selector" class="avatar-grid"></div>
                </div>

                <div class="name-input-footer">
                    <button id="start-game-btn" class="btn start-btn">开始游戏</button>
                </div>
            </div>
        </div>
    </div>



    <!-- 背景层 -->
    <div id="game-bg"></div>

    <div class="container">
        <!-- H1 标题移除或隐藏，由 Bento Grid 替代 -->
        <h1 style="display: none;">🎮 五子棋谭</h1>

        <button id="music-toggle" class="music-btn" style="display: none;" title="背景音乐">🔇 音乐</button>
        <div class="volume-control" style="display: none;">
            <span class="volume-icon">🔊</span>
            <input type="range" id="volume-slider" min="0" max="100" value="50" class="volume-slider">
        </div>

        <!-- NEW: 主界面 Bento Grid 容器 (Target Layout) -->
        <div id="main-menu-view" class="main-menu-view hidden">
            <!-- 1. 顶部信息栏 (Split Layout) -->
            <div class="menu-top-bar">
                <div class="user-info-pill glass-card" onclick="PlayerStats.openStatsModal()" style="cursor: pointer;"
                    title="点击查看个人战绩">
                    <div class="user-avatar-small" id="menu-user-avatar">🦁</div>
                    <div class="user-name-text">
                        <div id="menu-user-name">玩家8848</div>
                        <div class="user-rank-status">尚未定级</div>
                    </div>
                </div>
                <!-- 顶部右侧装饰或功能（如设置入口，也可留空） -->
            </div>

            <!-- 2. 中部核心网格 (Updated Layout) -->
            <div class="menu-grid">
                <!-- Row 1: 快速匹配 (Hero Card, Span 2) -->
                <div id="quick-match-btn-menu" class="menu-card hero-card" onclick="game.startQuickMatch()">
                    <div class="card-content">
                        <div class="hero-title" data-i18n="menu.quick_match">快速匹配</div>
                        <div class="hero-subtitle" data-i18n="menu.quick_match_desc">实时真人PK / 极速开局</div>
                        <div class="online-status-pill" style="white-space: nowrap;">
                            <span class="status-dot"></span>
                            <span id="menu-online-label" data-i18n="menu.status_online">在线中</span>: <span
                                id="menu-online-count">--</span>
                            <span style="opacity:0.6; margin:0 6px">|</span>
                            <span id="menu-playing-label" data-i18n="menu.status_playing">对战中</span>: <span
                                id="menu-playing-count">--</span>
                        </div>
                    </div>
                    <div class="card-decor-img">
                        <!-- CSS background or embedded svg/img -->
                        🎯
                    </div>
                    <!-- Glow effect container -->
                </div>

                <!-- Row 2: 创建房间 & 加入房间 -->
                <div id="create-room-btn-menu" class="menu-card glass-card row-card" onclick="game.createOnlineRoom()">
                    <div class="row-card-content">
                        <div class="card-icon-small">🏠</div>
                        <div class="card-text">
                            <div class="card-title" data-i18n="menu.create_room">创建房间</div>
                        </div>
                    </div>
                </div>

                <div id="join-room-btn-menu" class="menu-card glass-card row-card" onclick="UI.showJoinRoom()">
                    <div class="row-card-content">
                        <div class="card-icon-small">🚪</div>
                        <div class="card-text">
                            <div class="card-title" data-i18n="menu.join_room">加入房间</div>
                        </div>
                    </div>
                </div>

                <!-- Row 3: 人机对弈 & 故事模式 -->
                <div id="pve-btn" class="menu-card glass-card row-card" onclick="game.startPVEMode()">
                    <div class="row-card-content">
                        <div class="card-icon-small">🤖</div>
                        <div class="card-text">
                            <div class="card-title" data-i18n="menu.pve">人机对弈</div>
                        </div>
                    </div>
                </div>

                <div id="new-story-btn" class="menu-card glass-card row-card" onclick="game.startStoryMode()">
                    <div class="row-card-content">
                        <div class="card-icon-small">📖</div>
                        <div class="card-text">
                            <div class="card-title" data-i18n="menu.story">故事模式</div>
                            <div style="font-size:12px; opacity:0.7; margin-top:2px" id="menu-story-count">-- 人在线
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 4: Spectate (Wide Pill) -->
                <div id="spectate-btn-menu" class="menu-card glass-card wide-card" onclick="game.openSpectateLobby()">
                    <div class="wide-content">
                        <span class="wide-icon">👁️</span>
                        <span class="wide-label" data-i18n="menu.spectate">观战对局</span>
                    </div>
                </div>
            </div>

            <!-- 3. 底部 Dock 栏 -->
            <div class="bottom-dock glass-card">
                <div class="dock-item" onclick="UI.showHistory()">
                    <span class="dock-icon">📜</span>
                    <span class="dock-label" data-i18n="menu.history">历史</span>
                </div>
                <div class="dock-item" onclick="game.showLeaderboard()">
                    <span class="dock-icon">🏆</span>
                    <span class="dock-label" data-i18n="menu.leaderboard">排行榜</span>
                </div>
                <div class="dock-item" onclick="Community.show()">
                    <span class="dock-icon">🏠</span>
                    <span class="dock-label" data-i18n="menu.community">棋友圈</span>
                </div>
                <div class="dock-item" onclick="UI.openSettings()">
                    <span class="dock-icon">⚙️</span>
                    <span class="dock-label" data-i18n="menu.settings">设置</span>
                </div>
            </div>
        </div>

        <!-- OLD: 旧版折叠菜单 (保留结构以防报错，但在逻辑中不再调用显示) -->
        <div id="mode-select" class="modal hidden" style="display: none !important;">
            <div class="modal-content mode-select-content">
                <!-- Old Content Preserved purely for JS compatibility until cleanup -->
                <button id="pve-btn-old" class="hidden"></button>
                <button id="online-btn-old" class="hidden"></button>
            </div>
        </div>


        <!-- 联机大厅弹窗 -->
        <div id="online-lobby-modal" class="modal hidden">
            <div class="modal-content online-lobby-content">
                <div class="modal-header">
                    <h2>🌐 联机对战</h2>
                    <button class="close-btn" onclick="UI.closeOnlineLobby()">✕</button>
                </div>
                <div class="online-lobby-body">
                    <div class="online-status">
                        <span class="status-dot online"></span>
                        <span id="online-count">在线玩家: --</span>
                    </div>

                    <div class="lobby-options">
                        <button id="create-room-btn" class="btn lobby-btn">
                            <span class="btn-icon">🏠</span>
                            <span class="btn-text">
                                <span class="btn-title">创建房间</span>
                                <span class="btn-subtitle">邀请好友一起玩</span>
                            </span>
                        </button>

                        <button id="join-room-btn" class="btn lobby-btn">
                            <span class="btn-icon">🚪</span>
                            <span class="btn-text">
                                <span class="btn-title">加入房间</span>
                                <span class="btn-subtitle">输入房间码加入</span>
                            </span>
                        </button>

                        <button id="quick-match-btn" class="btn lobby-btn">
                            <span class="btn-icon">🎯</span>
                            <span class="btn-text">
                                <span class="btn-title">快速匹配</span>
                                <span class="btn-subtitle">随机匹配对手</span>
                            </span>
                        </button>

                        <button id="spectate-btn" class="btn lobby-btn">
                            <span class="btn-icon">👁️</span>
                            <span class="btn-text">
                                <span class="btn-title">观战对局</span>
                                <span class="btn-subtitle">观看进行中的对局</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 匹配中弹窗 -->
        <div id="matchmaking-modal" class="modal hidden">
            <div class="modal-content matchmaking-content">
                <div class="matchmaking-animation">
                    <div class="searching-spinner"></div>
                    <div class="searching-text">🔍 正在匹配对手...</div>
                </div>
                <div class="matchmaking-timer" id="matchmaking-timer">00:00</div>
                <button id="cancel-match-btn" class="btn secondary-btn">取消匹配</button>
            </div>
        </div>

        <!-- 加入房间弹窗 -->
        <div id="join-room-modal" class="modal hidden">
            <div class="modal-content join-room-content">
                <div class="modal-header">
                    <h2>🚪 加入房间</h2>
                    <button class="close-btn" onclick="UI.closeJoinRoom()">✕</button>
                </div>
                <div class="join-room-body">
                    <label for="room-code-input">请输入6位房间码</label>
                    <input type="text" id="room-code-input" class="room-code-input" placeholder="例如: ABC123"
                        maxlength="6" autocomplete="off">
                    <div id="join-room-error" class="error-message hidden"></div>
                    <button id="confirm-join-btn" class="btn primary-btn">加入房间</button>
                </div>
            </div>
        </div>

        <!-- 房间等待弹窗 -->
        <div id="room-waiting-modal" class="modal hidden">
            <div class="modal-content room-waiting-content">
                <div class="modal-header">
                    <h2>🎮 房间</h2>
                    <div class="room-code-display">
                        <span id="display-room-code">------</span>
                        <button class="copy-btn" onclick="UI.copyRoomCode()">📋 复制</button>
                    </div>
                </div>
                <div class="room-waiting-body">
                    <div class="players-display">
                        <div class="player-card host">
                            <div class="player-avatar" id="host-avatar">👤</div>
                            <div class="player-name" id="host-name">等待中...</div>
                            <div class="player-color">执黑</div>
                            <div class="player-status" id="host-status">未准备</div>
                        </div>
                        <div class="vs-divider">VS</div>
                        <div class="player-card guest">
                            <div class="player-avatar" id="guest-avatar">❓</div>
                            <div class="player-name" id="guest-name">等待加入...</div>
                            <div class="player-color">执白</div>
                            <div class="player-status" id="guest-status">--</div>
                        </div>
                    </div>

                    <div class="room-actions">
                        <button id="ready-btn" class="btn ready-btn">准备</button>
                        <button id="leave-room-btn" class="btn secondary-btn">退出房间</button>
                    </div>

                    <div id="room-message" class="room-message"></div>
                </div>
            </div>
        </div>

        <!-- 观战大厅弹窗 -->
        <div id="spectate-lobby-modal" class="modal hidden">
            <div class="modal-content spectate-lobby-content">
                <div class="modal-header">
                    <h2>👁️ 观战大厅</h2>
                    <div class="spectate-actions">
                        <button id="spectate-refresh-btn" class="refresh-btn" title="刷新">🔄</button>
                        <button class="close-btn" onclick="game.closeSpectateLobby()">✕</button>
                    </div>
                </div>
                <div class="spectate-lobby-body">
                    <div class="spectate-status">
                        <span id="active-games-count">正在进行的对局: 0</span>
                    </div>
                    <div id="game-list" class="game-list">
                        <div class="empty-games">暂无进行中的对局</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 留言板弹窗 -->
        <div id="feedback-modal" class="modal hidden">
            <!-- ... existing feedback content ... -->
            <div class="modal-content feedback-content">
                <div class="feedback-header">
                    <h2>💬 内测留言板</h2>
                    <button class="close-btn" onclick="closeFeedbackModal()">✕</button>
                </div>
                <div class="feedback-body">
                    <!-- 留言类型选择 -->
                    <div class="feedback-type-row">
                        <label>留言类型:</label>
                        <select id="feedback-type" class="feedback-type-select">
                            <option value="suggestion">💡 建议</option>
                            <option value="bug">🐛 Bug报告</option>
                            <option value="question">❓ 问题咨询</option>
                        </select>
                    </div>
                    <textarea id="feedback-text" class="feedback-textarea" placeholder="请写下您的建议或遇到的Bug..." rows="4"
                        maxlength="500"></textarea>
                    <div class="feedback-counter"><span id="feedback-count">0</span>/500</div>
                    <div style="margin-top:10px; opacity:0.7; font-size:0.9em;">
                        <span data-i18n="menu.contact_optional">联系方式 (选填)</span>:
                        <input type="text" id="feedback-contact"
                            style="background:rgba(255,255,255,0.1); border:none; color:white; padding:4px 8px; border-radius:4px; width:60%;">
                    </div>
                </div>
                <div class="feedback-footer">
                    <button id="feedback-submit-btn" class="btn feedback-submit-btn" onclick="submitFeedback()">👍
                        提交建议</button>
                </div>
                <div id="feedback-history" class="feedback-history"></div>
            </div>
        </div>


        <!-- 设置弹窗 - Premium Glass Style -->
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content settings-modal-content">
                <!-- Header -->
                <div class="settings-header">
                    <h2>⚙️ 游戏设置</h2>
                    <button class="close-btn" onclick="UI.closeSettings()">✕</button>
                </div>

                <div class="settings-body">
                    <!-- 🔊 音频设置组 -->
                    <div class="settings-group">
                        <div class="settings-group-title">
                            <span class="group-icon">🎧</span>
                            <span>音频设置</span>
                        </div>

                        <div class="settings-card">
                            <div class="setting-row">
                                <div class="setting-label">
                                    <span class="setting-icon">🎵</span>
                                    <span>背景音乐</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="setting-music-toggle" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>

                            <div class="setting-row">
                                <div class="setting-label">
                                    <span class="setting-icon">🔊</span>
                                    <span>音效</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="setting-sound-toggle" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>

                            <div class="setting-row volume-row">
                                <div class="setting-label">
                                    <span class="setting-icon">🎚️</span>
                                    <span>主音量</span>
                                </div>
                                <span class="volume-value" id="volume-value-display">50%</span>
                            </div>
                            <div class="volume-slider-container">
                                <input type="range" id="setting-volume-slider" min="0" max="100" value="50"
                                    class="premium-slider">
                            </div>
                        </div>
                    </div>

                    <!-- 🌐 语言设置组 -->
                    <div class="settings-group">
                        <div class="settings-group-title">
                            <span class="group-icon">🌐</span>
                            <span>语言 / Language</span>
                        </div>

                        <div class="settings-card">
                            <select id="setting-language-select" class="premium-select"
                                onchange="Localization.setLanguage(this.value)">
                                <option value="zh">🇨🇳 中文</option>
                                <option value="en">🇺🇸 English</option>
                                <option value="ja">🇯🇵 日本語</option>
                                <option value="ko">🇰🇷 한국어</option>
                            </select>
                        </div>
                    </div>

                    <!-- 📱 其他设置组 -->
                    <div class="settings-group">
                        <div class="settings-group-title">
                            <span class="group-icon">📱</span>
                            <span>其他</span>
                        </div>

                        <div class="settings-card clickable-card">
                            <div class="setting-row clickable" id="pwa-install-setting"
                                onclick="PWAInstall.triggerInstall()">
                                <div class="setting-label">
                                    <span class="setting-icon">📲</span>
                                    <span>保存到桌面</span>
                                </div>
                                <span class="arrow-icon">›</span>
                            </div>

                            <div class="setting-row clickable" onclick="showAboutModal()">
                                <div class="setting-label">
                                    <span class="setting-icon">ℹ️</span>
                                    <span>关于游戏</span>
                                </div>
                                <span class="arrow-icon">›</span>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="settings-footer">
                        <span class="version-text">Version 2.1 Beta</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 世界排行榜弹窗 -->
        <div id="leaderboard-modal" class="modal hidden">
            <div class="modal-content leaderboard-modal-content">
                <div class="leaderboard-header">
                    <h2>🏆 世界排行榜</h2>
                    <div class="leaderboard-actions">
                        <button id="leaderboard-refresh-btn" class="refresh-btn" title="刷新">🔄</button>
                        <button id="leaderboard-close-btn" class="close-btn">✕</button>
                    </div>
                </div>

                <!-- NEW: Tabs -->
                <div class="leaderboard-tabs">
                    <button class="lb-tab active" data-tab="all">总榜</button>
                    <button class="lb-tab" data-tab="daily">今日</button>
                    <button class="lb-tab" data-tab="hourly">1小时</button>
                </div>

                <div class="leaderboard-subtitle">TOP 10 玩家 · 按ELO排名</div>
                <div id="leaderboard-list" class="leaderboard-list">
                    <div class="leaderboard-loading">🔄 加载中...</div>
                </div>
            </div>
        </div>

        <!-- 个人战绩弹窗 -->
        <!-- 个人中心 (Personal Center) -->
        <div id="stats-modal" class="modal hidden">
            <div class="modal-content personal-center-content">
                <!-- 1. Header -->
                <div class="pc-header">
                    <h2>个人中心</h2>
                    <button id="stats-close-btn" class="close-btn">✕</button>
                </div>

                <!-- 2. Profile Section -->
                <div class="pc-profile-section">
                    <div class="pc-avatar-container">
                        <div class="pc-avatar" id="stats-player-avatar">
                            🦁
                        </div>
                    </div>
                    <div class="pc-info-container">
                        <div class="pc-name-row">
                            <span id="stats-player-name" class="pc-name">玩家8848</span>
                            <button id="stats-rename-btn" class="pc-rename-btn">✏️</button>
                        </div>
                        <div class="pc-rank-row">
                            <span class="pc-rank-icon" id="stats-rank-icon">🥉</span>
                            <div class="pc-rank-text">
                                <div class="pc-rank-title" id="stats-rank-name">青铜棋士</div>
                                <div class="pc-rank-progress-track">
                                    <div class="pc-rank-progress-bar" id="stats-rank-bar" style="width: 50%"></div>
                                </div>
                                <div class="pc-rank-val" id="stats-rank-val">1250/2000</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Stats Grid (2x2) -->
                <div class="pc-stats-grid">
                    <!-- NEW: ELO Chart (Span 2) -->
                    <div class="pc-stat-card full-width">
                        <div class="pc-stat-label">ELO水平走势</div>
                        <div class="chart-container" style="width: 100%; height: 120px; position: relative;">
                            <canvas id="elo-chart-canvas"></canvas>
                        </div>
                    </div>

                    <!-- Card 1: Win Rate (Circular) -->
                    <div class="pc-stat-card">
                        <div class="circular-chart" id="stats-winrate-chart" style="--percentage: 58">
                            <svg viewBox="0 0 36 36" class="circular-svg">
                                <path class="circle-bg"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path class="circle" stroke-dasharray="58, 100"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            </svg>
                            <div class="percentage-text">
                                <span class="label">胜率</span>
                                <span class="value" id="stats-winrate-text">58%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Card 2: Total Games -->
                    <div class="pc-stat-card">
                        <div class="pc-stat-label">总局数</div>
                        <div class="pc-stat-value" id="stats-total-games">1204</div>
                    </div>

                    <!-- Card 3: Max Streak -->
                    <div class="pc-stat-card">
                        <div class="pc-stat-label">最高连胜</div>
                        <div class="pc-stat-value">
                            <span id="stats-max-streak">12</span> <span class="icon">🔥</span>
                        </div>
                    </div>

                    <!-- Card 4: MVP/Wins -->
                    <div class="pc-stat-card">
                        <div class="pc-stat-label">胜场数</div>
                        <div class="pc-stat-value">
                            <span id="stats-total-wins">85</span> <span class="icon">🏆</span>
                        </div>
                    </div>
                </div>

                <!-- 4. User ID Footer -->
                <div class="pc-settings-footer"
                    style="justify-content: center; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); flex-direction: column; align-items: center; gap: 5px;">

                    <!-- NEW: User ID Pill -->
                    <div class="user-id-pill" title="您的唯一数字ID">
                        <span style="opacity: 0.5; font-size: 12px; margin-right: 8px; font-weight: 500;">UID</span>
                        <span id="stats-user-id"
                            style="font-family: 'Courier New', monospace; font-size: 16px; letter-spacing: 1px; font-weight: bold; color: #ffd700;">--</span>
                    </div>

                    <div class="footer-actions">
                        <!-- Moved About to Settings -->
                    </div>
                </div>

                <!-- Rename Form (Hidden by default, overlaid) -->

                <!-- Rename Form (Hidden by default, overlaid) -->
                <div id="rename-form" class="rename-form hidden">
                    <input type="text" id="rename-input" class="rename-input" placeholder="请输入新名字" maxlength="12">
                    <div class="rename-actions">
                        <button id="rename-confirm-btn" class="btn rename-confirm">确认</button>
                        <button id="rename-cancel-btn" class="btn rename-cancel">取消</button>
                    </div>
                </div>

                <!-- Avatar Selector Panel (Hidden by default) -->
                <div id="stats-avatar-selector" class="avatar-selector-panel hidden">
                    <div class="avatar-selector-header">
                        <h3>选择头像</h3>
                        <button class="close-btn" onclick="PlayerStats.hideAvatarSelector()">✕</button>
                    </div>
                    <div id="stats-avatar-grid" class="avatar-grid">
                        <!-- Avatars will be rendered by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 温故知新关卡选择弹窗 -->
        <div id="mission-select-modal" class="modal hidden">
            <div class="modal-content mission-select-content">
                <div class="mission-select-header">
                    <h2>📚 温故知新</h2>
                    <p id="mission-progress-text" class="progress-text">当前进度：已解锁到第 1 关</p>
                    <button id="mission-select-close" class="close-btn">✕</button>
                </div>
                <div id="mission-list" class="mission-list">
                    <!-- 关卡列表将由JS动态生成 -->
                </div>
            </div>
        </div>

        <!-- AI难度选择弹窗 -->
        <div id="ai-difficulty-modal" class="modal hidden">
            <div class="modal-content difficulty-content">
                <h2>🤖 选择AI难度</h2>
                <div class="difficulty-options">
                    <button class="difficulty-btn" data-level="1" onclick="selectAIDifficulty(1)">
                        <span class="diff-icon">🌱</span>
                        <span class="diff-name">简单</span>
                        <span class="diff-desc">适合新手入门</span>
                    </button>
                    <button class="difficulty-btn selected" data-level="2" onclick="selectAIDifficulty(2)">
                        <span class="diff-icon">⚔️</span>
                        <span class="diff-name">普通</span>
                        <span class="diff-desc">有一定挑战</span>
                    </button>
                    <button class="difficulty-btn" data-level="3" onclick="selectAIDifficulty(3)">
                        <span class="diff-icon">🔥</span>
                        <span class="diff-name">困难</span>
                        <span class="diff-desc">高手过招</span>
                    </button>
                </div>
                <div class="difficulty-actions">
                    <button class="btn difficulty-start-btn" onclick="startGameWithDifficulty()">开始对局</button>
                    <button class="btn difficulty-cancel-btn" onclick="closeDifficultyModal()">取消</button>
                </div>
            </div>
        </div>

        <div id="rps-modal" class="modal hidden">
            <div class="modal-content rps-content">
                <h2>✊✌️🖐️ 剪刀石头布决定先手</h2>
                <div class="rps-game">
                    <div class="rps-player" id="rps-p1">
                        <div class="rps-label">玩家1</div>
                        <div class="rps-choices" id="p1-choices">
                            <button class="rps-btn" data-choice="rock">✊</button>
                            <button class="rps-btn" data-choice="scissors">✌️</button>
                            <button class="rps-btn" data-choice="paper">🖐️</button>
                        </div>
                        <div class="rps-selected hidden" id="p1-selected"></div>
                    </div>
                    <div class="rps-vs">VS</div>
                    <div class="rps-player" id="rps-p2">
                        <div class="rps-label" id="p2-label">玩家2</div>
                        <div class="rps-choices" id="p2-choices">
                            <button class="rps-btn" data-choice="rock">✊</button>
                            <button class="rps-btn" data-choice="scissors">✌️</button>
                            <button class="rps-btn" data-choice="paper">🖐️</button>
                        </div>
                        <div class="rps-selected hidden" id="p2-selected"></div>
                    </div>
                </div>
                <div id="rps-result" class="rps-result hidden"></div>
                <div id="rps-waiting" class="rps-waiting">等待玩家1选择...</div>
            </div>
        </div>

        <!-- 倒计时弹窗 -->
        <div id="countdown-modal" class="modal hidden">
            <div class="countdown-content">
                <div id="countdown-number" class="countdown-number">3</div>
            </div>
        </div>

        <div class="game-info">
            <!-- 故事模式专用HUD（默认隐藏）- 新三栏式布局 -->
            <div id="story-hud" class="story-hud hidden">
                <!-- 左侧：关卡信息 -->
                <div class="story-hud-left">
                    <div class="story-hud-title" id="story-hud-title">第一关 · 居家书房</div>
                    <div class="story-hud-subtitle">故事模式</div>
                </div>

                <!-- 中间：规则标签 -->
                <div class="story-hud-center" id="story-hud-tags">
                    <span class="rule-tag"><span class="tag-icon">🚫</span>禁手：关闭</span>
                    <span class="rule-tag"><span class="tag-icon">⏱️</span>计时：不限时</span>
                    <span class="rule-tag"><span class="tag-icon">📋</span>局面：空盘开局</span>
                    <span class="rule-tag"><span class="tag-icon">⭐</span>难度：入门</span>
                </div>

                <!-- 右侧：技能状态 -->
                <div class="story-hud-right">
                    <div class="skill-indicator skill-data-view disabled" id="skill-data-view">
                        <span class="skill-icon">👁️</span>
                        <span class="skill-count">0</span>
                    </div>
                </div>
            </div>

            <!-- 灵魂对决 (Soul Duel) 头部容器 -->
            <div id="online-header" class="soul-header-layout hidden">
                <!-- 玩家1 (左) -->
                <div id="p1-card" class="soul-card left">
                    <div class="soul-avatar-container" onclick="UI.onAvatarClick(1)">
                        <!-- 倒计时光环 SVG -->
                        <svg class="soul-ring-svg" viewBox="0 0 100 100">
                            <circle class="soul-ring-bg" cx="50" cy="50" r="46"></circle>
                            <circle id="p1-timer-ring" class="soul-ring-progress" cx="50" cy="50" r="46"></circle>
                        </svg>
                        <div id="p1-avatar" class="soul-avatar-emoji">🦊</div>
                        <div class="soul-status-icon" id="p1-status-icon">⚫</div>
                        <!-- 聊天气泡 -->
                        <div id="black-chat-bubble" class="chat-bubble left hidden"></div>
                    </div>
                    <div class="soul-info">
                        <div id="p1-name" class="soul-name">Player 1</div>
                        <div id="p1-elo" class="soul-elo">1000</div>
                        <div id="p1-timer" class="soul-timer">05:00</div>
                    </div>
                </div>

                <!-- 玩家2 (右) -->
                <div id="p2-card" class="soul-card right">
                    <div class="soul-info">
                        <div id="p2-name" class="soul-name">Player 2</div>
                        <div id="p2-elo" class="soul-elo">1000</div>
                        <div id="p2-timer" class="soul-timer">05:00</div>
                    </div>
                    <div class="soul-avatar-container" onclick="UI.onAvatarClick(2)">
                        <svg class="soul-ring-svg" viewBox="0 0 100 100">
                            <circle class="soul-ring-bg" cx="50" cy="50" r="46"></circle>
                            <circle id="p2-timer-ring" class="soul-ring-progress" cx="50" cy="50" r="46"></circle>
                        </svg>
                        <div id="p2-avatar" class="soul-avatar-emoji">🐯</div>
                        <div class="soul-status-icon" id="p2-status-icon">⚪</div>
                        <!-- 聊天气泡 -->
                        <div id="white-chat-bubble" class="chat-bubble right hidden"></div>
                    </div>
                </div>
            </div>

            <!-- 隐藏旧元素以兼容代码 -->
            <div class="hidden-legacy-ui hidden">
                <div class="player black-player" id="black-label"></div>
                <div class="player white-player" id="white-label"></div>
                <div class="current-turn" id="turn-display"><span id="current-player"></span></div>
                <div class="game-timer" id="game-timer-container"><span id="game-timer"></span></div>
                <div class="game-mode-display" id="game-mode-display"></div>
            </div>
        </div>

        <div class="game-layout hidden">
            <div class="game-container">
                <canvas id="board" width="600" height="600"></canvas>
            </div>

            <!-- 角色"弈·零"展示区域 -->
            <div class="character-wrapper hidden" id="character-wrapper">
                <!-- 角色立绘 -->
                <div class="char-frame">
                    <img id="char-img" src="assets/images/char_idle.webp" alt="弈·零" class="char-sprite" loading="lazy">
                    <!-- 视觉特效层 -->
                    <div id="vfx-overlay" class="vfx-overlay"></div>
                </div>

                <!-- 角色名称 -->
                <div class="char-name">弈·零</div>

                <!-- 对话框 -->
                <div id="dialogue-box" class="dialogue-box hidden">
                    <p id="dialogue-text">...</p>
                </div>
            </div>
        </div>

        <div class="controls hidden">
            <button id="restart-btn" class="btn">🔄 重新开始</button>
            <button id="undo-btn" class="btn">↩️ 悔棋</button>
            <button id="surrender-btn" class="btn hidden">🏳️ 认输</button>
            <div class="chat-wrapper">
                <button id="chat-btn" class="btn hidden">💬</button>
                <div id="chat-panel" class="chat-panel hidden">
                    <button class="chat-option" data-msg="greeting">👋 你好</button>
                    <button class="chat-option" data-msg="hurry">⏰ 快点</button>
                    <button class="chat-option" data-msg="praise">👍 厉害</button>
                    <button class="chat-option" data-msg="gg">🤝 承让</button>
                    <button class="chat-option" data-msg="oops">😱 失误</button>
                    <button class="chat-option" data-msg="again">🔄 再来</button>
                </div>
            </div>
            <button id="change-mode-btn" class="btn">🎮 切换模式</button>
        </div>

        <div id="winner-modal" class="modal hidden">
            <div class="modal-content">
                <h2 id="winner-title">本局结算</h2>
                <p id="winner-message" class="winner-message"></p>

                <!-- 结算进度条区域 -->
                <div id="settlement-progress-container" class="settlement-container hidden">
                    <div class="settlement-info-row">
                        <span id="settlement-rank-name" class="settlement-rank">青铜</span>
                        <span id="settlement-elo-change" class="settlement-elo">1000</span>
                    </div>
                    <div class="settlement-bar-bg">
                        <div id="settlement-progress-bar" class="settlement-bar-fill" style="width: 0%"></div>
                    </div>
                    <div id="settlement-next-tip" class="settlement-tip">距离下一段位还需 100 分</div>
                </div>

                <div class="modal-buttons">
                    <button id="play-again-btn" class="btn primary-btn">🔄 再来一局</button>
                    <button id="back-to-menu-btn" class="btn secondary-btn">🏠 返回菜单</button>
                </div>
            </div>
        </div>

        <!-- 再来一局邀请弹窗 -->
        <div id="rematch-modal" class="modal hidden">
            <div class="modal-content rematch-content">
                <h2>🎮 再来一局？</h2>
                <p id="rematch-message">对手想再来一局！</p>
                <div class="rematch-buttons">
                    <button id="accept-rematch-btn" class="btn winner-btn">✅ 接受</button>
                    <button id="reject-rematch-btn" class="btn winner-btn secondary">❌ 拒绝</button>
                </div>
            </div>
        </div>

        <div id="ai-thinking" class="ai-thinking hidden">🤖 AI思考中...</div>

        <!-- 故事对话弹窗 -->
        <div id="story-dialog-modal" class="modal hidden">
            <div class="story-dialog-wrapper">
                <!-- 立绘区域 -->
                <div class="story-portrait-area" id="story-portrait-area">
                    <img id="story-portrait" class="story-portrait hidden" src="" alt="" loading="lazy">
                </div>
                <!-- 对话框 -->
                <div class="story-dialog-content">
                    <button id="skip-dialog-btn" class="skip-dialog-btn">跳过 ⏭️</button>
                    <div class="story-dialog-speaker" id="story-speaker"></div>
                    <div class="story-dialog-text" id="story-text"></div>
                    <div class="story-dialog-hint">点击继续...</div>
                </div>
            </div>
        </div>

        <!-- 任务简报面板 -->
        <div id="mission-brief-modal" class="modal hidden">
            <div class="modal-content mission-brief-content">
                <div class="mission-brief-header">
                    <h2 id="mission-brief-title">第一关 · 居家书房</h2>
                    <p id="mission-brief-subtitle" class="mission-subtitle">第一次对弈 · 唤醒弈·零</p>
                </div>
                <div class="mission-brief-body">
                    <div class="brief-section">
                        <h3>📜 本关规则</h3>
                        <p id="mission-rule-text"></p>
                    </div>
                    <div class="brief-section">
                        <h3>🎯 任务目标</h3>
                        <p id="mission-goal-text"></p>
                    </div>
                </div>
                <div class="mission-brief-buttons">
                    <button id="mission-start-btn" class="btn mission-btn primary">开始对局</button>
                    <button id="mission-cancel-btn" class="btn mission-btn secondary">返回</button>
                </div>
            </div>
        </div>

        <!-- 段位晋升面板 -->
        <div id="rank-up-modal" class="modal hidden">
            <div class="modal-content rank-up-content">
                <div class="rank-up-icon">🏆</div>
                <h2>段位晋升！</h2>
                <div class="rank-up-title" id="rank-up-title">见习九级</div>
                <p class="rank-up-desc" id="rank-up-desc">你和弈·零完成了第一次正式对弈。</p>
                <button id="rank-up-confirm" class="btn rank-up-btn">确定</button>
            </div>
        </div>

        <!-- 禁手提示弹窗 -->
        <div id="forbidden-toast" class="toast hidden">
            <span class="toast-icon">⚠️</span>
            <span class="toast-text" id="forbidden-toast-text">这一步是禁手，请换一个位置。</span>
        </div>
    </div>

    <!-- 优雅的浮动咖啡按钮 -->
    <div class="coffee-float-btn" id="coffee-btn" onclick="showDonateModal()">
        <span class="coffee-icon">☕</span>
        <span class="coffee-text">请作者喝咖啡</span>
    </div>

    <!-- 捐赠弹窗 - 重新设计 -->
    <div id="donate-modal" class="modal hidden">
        <div class="modal-content donate-content-new">
            <button class="donate-close-btn" onclick="closeDonateModal()">×</button>

            <div class="donate-header">
                <div class="coffee-steam">☕</div>
                <h2>来杯咖啡？</h2>
                <p class="donate-subtitle">这个游戏陪你消磨了一些时光，<br>如果你觉得还不错…</p>
            </div>

            <div class="coffee-menu">
                <p class="menu-hint">选一杯请作者喝：</p>

                <div class="coffee-options">
                    <div class="coffee-option" data-price="5" onclick="selectCoffee(this)">
                        <span class="option-icon">☕</span>
                        <span class="option-name">浓缩</span>
                        <span class="option-price">¥5</span>
                    </div>
                    <div class="coffee-option" data-price="10" onclick="selectCoffee(this)">
                        <span class="option-icon">🥛</span>
                        <span class="option-name">拿铁</span>
                        <span class="option-price">¥10</span>
                    </div>
                    <div class="coffee-option selected" data-price="20" onclick="selectCoffee(this)">
                        <span class="option-icon">🍫</span>
                        <span class="option-name">摩卡</span>
                        <span class="option-price">¥20</span>
                    </div>
                    <div class="coffee-option" data-price="50" onclick="selectCoffee(this)">
                        <span class="option-icon">✨</span>
                        <span class="option-name">特调</span>
                        <span class="option-price">¥50</span>
                    </div>
                </div>

                <div class="custom-amount">
                    <span>或者，随心意：</span>
                    <input type="number" id="custom-coffee-amount" placeholder="任意金额" min="1" max="999">
                    <span>元</span>
                </div>
            </div>

            <div class="donate-actions">
                <button class="btn donate-confirm-btn" onclick="showWechatModal()">
                    <span>好的，请你喝</span>
                </button>
                <button class="btn donate-skip-btn" onclick="closeDonateModal()">
                    下次再说
                </button>
            </div>

            <p class="donate-footer">💡 金额只是心意，完全自愿，不影响游戏体验</p>
        </div>
    </div>

    <!-- 微信二维码弹窗 - 重新设计 -->
    <div id="wechat-modal" class="modal hidden">
        <div class="modal-content wechat-content-new">
            <button class="wechat-close-btn" onclick="closeWechatModal()">×</button>

            <div class="wechat-header-new">
                <span class="thank-icon">☕</span>
                <h2>谢谢你的咖啡</h2>
            </div>

            <div class="wechat-qr-card">
                <img src="assets/images/wx.webp" alt="微信二维码" class="qr-image-new" loading="lazy">
                <p class="scan-hint">微信扫一扫，请我喝咖啡</p>
            </div>

            <div class="wechat-author">
                <p>作者：<span class="author-name-new">川狼</span></p>
                <p class="wechat-id-new">微信：XCX110</p>
            </div>

            <button class="btn wechat-done-btn" onclick="confirmDonateAndUnlock()">
                完成
            </button>

            <p class="wechat-footer">转账后可解锁全部关卡 ✨</p>
        </div>
    </div>

    <!-- 历史介绍面板 -->
    <div id="history-panel" class="history-panel hidden">
        <div class="history-header">
            <h1 id="history-title">纵横四千年：五子棋的"前身今生"</h1>
            <p id="history-subtitle" class="history-subtitle">从河图洛书，到 AI 时代</p>
        </div>
        <div id="history-content" class="history-content"></div>
        <div class="history-footer">
            <button id="history-close-btn" class="btn history-close-btn">返回主菜单</button>
        </div>
    </div>

    <!-- 游戏结束/结算弹窗 -->
    <div id="winner-modal" class="modal hidden">
        <div class="modal-content winner-content">
            <div id="winner-title">GAME OVER</div>
            <div class="winner-message" id="winner-message">You Win!</div>

            <!-- 结算数据卡片 -->
            <div class="settlement-container visible" id="settlement-container">
                <div class="settlement-info-row">
                    <span class="settlement-rank" id="settlement-rank">暂无段位</span>
                    <span class="settlement-elo" id="settlement-elo">1000</span>
                </div>

                <!-- 进度条 -->
                <div class="settlement-bar-bg">
                    <div class="settlement-bar-fill" id="settlement-bar" style="width: 0%"></div>
                </div>

                <div class="settlement-tip" id="settlement-tip">距离下一段位还需 100 分</div>
            </div>

            <div class="modal-buttons">
                <button class="btn primary-btn" id="winner-confirm-btn" onclick="UI.requestRematch()">再来一局</button>
                <button class="btn secondary-btn" onclick="UI.closeWinnerModal()">返回大厅</button>
            </div>
        </div>
    </div>

    <!-- 模块化JS文件 -->
    <!-- Utility modules (加载顺序最先) -->
    <script src="js/utils/BoardUtils.js"></script>
    <script src="js/utils/MultiplayerFix.js"></script>
    <script src="js/utils/RobustMatchmaking.js"></script>
    <script src="js/utils/MultiplayerUI.js"></script>

    <script src="js/names.js"></script>
    <!-- PWA Install Modal -->
    <div id="pwa-install-modal" class="modal hidden">
        <div class="modal-content glass-panel pwa-content">
            <div class="pwa-header">
                <div class="app-icon-preview">
                    <!-- 使用纯CSS占位符或默认图标 -->
                    <div class="default-icon">🎮</div>
                </div>
                <h3>安装「五子棋遇」</h3>
            </div>
            <p>添加到主屏幕，享受全屏沉浸式体验！</p>

            <!-- Android/PC Action -->
            <div id="pwa-install-action" class="pwa-actions">
                <button class="menu-btn primary-btn" id="pwa-install-btn">立即安装</button>
                <button class="menu-btn secondary-btn" id="pwa-dismiss-btn">暂不考虑</button>
            </div>

            <!-- iOS Guide -->
            <div id="pwa-ios-guide" class="pwa-ios-guide hidden">
                <p>轻点浏览器底部的 <span class="ios-share-icon">⎋</span> 图标</p>
                <p>然后选择 <strong>"添加到主屏幕"</strong> <span class="ios-add-icon">➕</span></p>
                <button class="menu-btn secondary-btn" id="pwa-ios-dismiss-btn">知道了</button>
            </div>
        </div>
    </div>

    <script src="js/pwa-install.js"></script>

    <!-- Core modules -->
    <script src="js/audio.js"></script>
    <script src="js/board.js"></script>
    <script src="js/ai.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/save.js"></script>
    <script src="js/missions.js"></script>
    <script src="js/character_data.js"></script>
    <script src="js/storyBackgrounds.js"></script>
    <script src="js/storyAiTempo.js"></script>
    <script src="js/storyLevelsConfig.js"></script>
    <script src="js/onboarding.js"></script>
    <script src="js/playerStats.js"></script>
    <script src="js/leaderboard.js"></script>
    <script src="js/localization.js"></script>
    <script src="js/cloudSync.js"></script>
    <script src="js/uiTexts.js"></script>
    <script src="js/forbiddenTexts.js"></script>
    <script src="js/gomokuHistory.js"></script>
    <script src="js/dialogs_m1.js"></script>
    <script src="js/dialogs_m2.js"></script>
    <script src="js/dialogs_m3.js"></script>
    <script src="js/dialogs_m4.js"></script>
    <script src="js/dialogs_m5.js"></script>
    <script src="js/dialogs_m6.js"></script>
    <script src="js/dialogs_m7.js"></script>
    <script src="js/menu.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/game/forbidden.js"></script>
    <script src="js/avatars.js"></script>
    <script src="js/elo.js"></script>
    <script src="js/nameGenerator.js"></script>
    <script src="js/network.js"></script>
    <script src="js/game.js"></script>

    <!-- Service Worker Registration -->
    <script>
        // Register Service Worker for PWA support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/sw.js')
                    .then(function (registration) {
                        console.log('[PWA] Service Worker registered:', registration.scope);
                    })
                    .catch(function (error) {
                        console.log('[PWA] Service Worker registration failed:', error);
                    });
            });
        }
    </script>
    <!-- 版本公告弹窗 -->
    <div id="version-modal" class="modal hidden">
        <div class="modal-content glass-panel version-content">
            <div class="version-header">
                <h2>✨ 两仪更新 v2.2</h2>
                <div class="version-date">2025.12.18</div>
            </div>

            <div class="version-list">
                <div class="version-item">
                    <div class="v-icon">⚛️</div>
                    <div class="v-text">
                        <h4>量子纠缠加载</h4>
                        <p>全新量子粒子与波纹动画，全中文沉浸式体验。</p>
                    </div>
                </div>

                <div class="version-item">
                    <div class="v-icon">📱</div>
                    <div class="v-text">
                        <h4>应用安装支持</h4>
                        <p>支持"添加到主屏幕" (PWA)，秒开游戏体验。</p>
                    </div>
                </div>

                <div class="version-item">
                    <div class="v-icon">🎨</div>
                    <div class="v-text">
                        <h4>体验深度优化</h4>
                        <p>修复联机对战UI，优化移动端触控与布局。</p>
                    </div>
                </div>
            </div>

            <div class="version-footer">
                <button class="menu-btn primary-btn" onclick="closeVersionModal()">开启新体验</button>
            </div>
        </div>
    </div>

    <!-- 棋友圈社区弹窗 -->
    <div id="community-modal" class="hidden">
        <div class="community-container">
            <!-- 头部 -->
            <div class="community-header">
                <div class="community-title">🏠 棋友圈</div>
                <div class="community-header-actions">
                    <button id="community-search-btn" class="community-action-btn" title="搜索">🔍</button>
                    <button id="community-notif-btn" class="community-action-btn" title="通知">
                        🔔
                        <span id="community-notif-badge" class="notif-badge hidden">0</span>
                    </button>
                    <button id="community-close-btn" class="community-close-btn">✕</button>
                </div>
            </div>

            <!-- 搜索框 -->
            <div id="community-search-box" class="community-search-box hidden">
                <input type="text" id="community-search-input" placeholder="搜索帖子..." maxlength="50">
                <button id="community-search-clear" class="search-clear-btn hidden">✕</button>
            </div>

            <!-- 通知面板 -->
            <div id="community-notif-panel" class="community-notif-panel hidden">
                <div class="notif-header">
                    <span>消息通知</span>
                    <button id="community-notif-readall" class="notif-readall-btn">全部已读</button>
                </div>
                <div id="community-notif-list" class="notif-list">
                    <div class="notif-empty">暂无新消息</div>
                </div>
            </div>

            <!-- 标签栏 -->
            <div class="community-tabs">
                <button class="community-tab active" data-type="all">💬 全部</button>
                <button class="community-tab" data-type="battle">⚔️ 约战</button>
                <button class="community-tab" data-type="replay">📋 棋谱</button>
                <button class="community-tab" data-type="announcement">📢 公告</button>
            </div>

            <!-- 内容区域 -->
            <div class="community-content">
                <!-- 加载中 -->
                <div id="community-loading">
                    <div class="loading-spinner"></div>
                </div>

                <!-- 列表视图 -->
                <div id="community-list-view" class="community-view">
                    <div id="community-posts-list" class="community-posts-list">
                        <!-- 帖子列表由 JS 渲染 -->
                    </div>
                    <button id="community-load-more" style="display: none;">📜 加载更多...</button>
                </div>

                <!-- 详情视图 -->
                <div id="community-detail-view" class="community-view hidden">
                    <div id="community-post-detail">
                        <!-- 帖子详情由 JS 渲染 -->
                    </div>
                </div>

                <!-- 发帖视图 -->
                <div id="community-create-view" class="community-view hidden">
                    <div class="create-form">
                        <div class="post-detail-header">
                            <button class="back-btn" onclick="Community.showListView()">← 返回</button>
                        </div>

                        <div class="create-form-group">
                            <label class="create-form-label">帖子类型</label>
                            <select id="create-post-type" class="create-type-select">
                                <option value="discussion">💬 讨论</option>
                                <option value="battle">⚔️ 约战</option>
                                <option value="replay">📋 棋谱分享</option>
                            </select>
                        </div>

                        <div class="create-form-group">
                            <label class="create-form-label">标题</label>
                            <input type="text" id="create-post-title" class="create-title-input"
                                placeholder="输入标题 (2-50字)" maxlength="50">
                        </div>

                        <div class="create-form-group">
                            <label class="create-form-label">内容</label>
                            <textarea id="create-post-content" class="create-content-input"
                                placeholder="写下你的内容... (5-2000字)" maxlength="2000"></textarea>
                        </div>

                        <div class="create-form-group">
                            <label class="create-form-label">图片 (可选，最多3张)</label>
                            <div id="create-post-images" class="create-images-preview"></div>
                            <input type="file" id="create-post-image-input" accept="image/*" style="display: none;"
                                onchange="handleImageUpload(this)">
                            <button class="action-btn-large"
                                onclick="document.getElementById('create-post-image-input').click()">
                                📷 添加图片
                            </button>
                        </div>

                        <button id="create-post-submit" class="create-submit-btn" onclick="Community.submitPost()">
                            📤 发布
                        </button>
                    </div>
                </div>

                <!-- 发帖浮动按钮 -->
                <button id="community-create-btn" class="community-fab">✏️</button>
            </div>
        </div>
    </div>

    <!-- 游戏分析 -->
    <script src="js/analytics.js"></script>

    <!-- 社区 JS -->
    <script src="js/community-api.js"></script>
    <script src="js/community.js"></script>
</body>


</html>